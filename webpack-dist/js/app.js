!function(e){function t(t){for(var o,r,l=t[0],c=t[1],i=t[2],f=0,p=[];f<l.length;f++)r=l[f],Object.prototype.hasOwnProperty.call(n,r)&&n[r]&&p.push(n[r][0]),n[r]=0;for(o in c)Object.prototype.hasOwnProperty.call(c,o)&&(e[o]=c[o]);for(d&&d(t);p.length;)p.shift()();return s.push.apply(s,i||[]),a()}function a(){for(var e,t=0;t<s.length;t++){for(var a=s[t],o=!0,l=1;l<a.length;l++){var c=a[l];0!==n[c]&&(o=!1)}o&&(s.splice(t--,1),e=r(r.s=a[0]))}return e}var o={},n={0:0},s=[];function r(t){if(o[t])return o[t].exports;var a=o[t]={i:t,l:!1,exports:{}};return e[t].call(a.exports,a,a.exports,r),a.l=!0,a.exports}r.m=e,r.c=o,r.d=function(e,t,a){r.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:a})},r.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},r.t=function(e,t){if(1&t&&(e=r(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var a=Object.create(null);if(r.r(a),Object.defineProperty(a,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var o in e)r.d(a,o,function(t){return e[t]}.bind(null,o));return a},r.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return r.d(t,"a",t),t},r.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},r.p="./";var l=window.webpackJsonp=window.webpackJsonp||[],c=l.push.bind(l);l.push=t,l=l.slice();for(var i=0;i<l.length;i++)t(l[i]);var d=c;s.push([106,1]),a()}({102:function(e,t){},103:function(e,t){},104:function(e,t,a){},105:function(e,t,a){},106:function(e,t,a){"use strict";a.r(t);var o=a(6),n=a(0),s=a.n(n),r=a(4),l=a(10),c=a.n(l),i=a(27),d=a.n(i),f=a(28),p=a.n(f),u=a(29),h=a.n(u);function g(e){const t=["TITLE","SUBTITLE","BPM","WAVE","OFFSET","DEMOSTART","GENRE","MAKER"],a=["COURSE","LEVEL","BALLOON","SCOREINIT","SCOREDIFF","NOTESDESIGNER0","NOTESDESIGNER1","NOTESDESIGNER2","NOTESDESIGNER3","NOTESDESIGNER4","TTROWBEAT"],o=["START","END","GOGOSTART","GOGOEND","MEASURE","SCROLL","BPMCHANGE","DELAY","BRANCHSTART","BRANCHEND","SECTION","N","E","M","LEVELHOLD","BMSCROLL","HBSCROLL","BARLINEOFF","BARLINEON","TTBREAK"];let n;if((n=e.match(/\/\/.*/))&&(e=e.substr(0,n.index).trim()),n=e.match(/^([A-Z0-9]+):(.+)/i)){const e=n[1].toUpperCase(),o=n[2];if(t.includes(e))return{type:"header",scope:"global",name:e,value:o.trim()};if(a.includes(e))return{type:"header",scope:"course",name:e,value:o.trim()}}else if(n=e.match(/^#([A-Z]+)(?:\s+(.+))?/i)){const e=n[1].toUpperCase(),t=n[2]||"";if(o.includes(e))return{type:"command",name:e,value:t.trim()}}else if(n=e.match(/^(([0-9]|A|B|C|D|F|G|H|I)*,?)$/)){return{type:"data",data:n[1]}}return{type:"unknown",value:e}}function b(e,t){const a={course:"Oni",level:0,balloon:[],scoreInit:100,scoreDiff:100,maker:null,ttRowBeat:16},o=[];let n=4,s=4,r={},l="",c=[],i="N",d="N",f=!1;for(const e of t)if("header"===e.type)switch(e.name){case"COURSE":a.course=e.value;break;case"LEVEL":a.level=parseInt(e.value,10);break;case"BALLOON":const t=e.value.split(/[^0-9]/).filter(e=>""!==e).map(e=>parseInt(e,10));a.balloon=t;break;case"SCOREINIT":a.scoreInit=parseInt(e.value,10);break;case"SCOREDIFF":a.scoreDiff=parseInt(e.value,10);break;case"NOTESDESIGNER0":case"NOTESDESIGNER1":case"NOTESDESIGNER2":case"NOTESDESIGNER3":case"NOTESDESIGNER4":a.maker=e.value;break;case"TTROWBEAT":a.ttRowBeat=parseInt(e.value,10)}else if("command"===e.type)switch(e.name){case"BRANCHSTART":if(f)break;let t=e.value.split(",");"r"===t[0]?d=t.length>=3?"M":2===t.length?"E":"N":"p"===t[0]&&(d=t.length>=3&&parseFloat(t[2])<=100?"M":t.length>=2&&parseFloat(t[1])<=100?"E":"N");break;case"BRANCHEND":i=d;break;case"N":i="N";break;case"E":i="E";break;case"M":i="M";break;case"START":case"END":i="N",d="N",f=!1;break;default:if(i!=d)break;switch(e.name){case"MEASURE":let t=e.value.match(/(\d+)\/(\d+)/);if(!t)break;n=parseInt(t[1],10),s=parseInt(t[2],10);break;case"GOGOSTART":c.push({name:"gogoStart",position:l.length});break;case"GOGOEND":c.push({name:"gogoEnd",position:l.length});break;case"SCROLL":c.push({name:"scroll",position:l.length,value:parseFloat(e.value)});break;case"BPMCHANGE":c.push({name:"bpm",position:l.length,value:parseFloat(e.value)});break;case"TTBREAK":r.ttBreak=!0;break;case"LEVELHOLD":f=!0}}else if("data"===e.type&&i===d){let t=e.data;if(t.endsWith(",")){l+=t.slice(0,-1);const e={length:[n,s],properties:r,data:l,events:c};o.push(e),l="",c=[],r={}}else l+=t}if(o.length){let t=!1;for(let e=0;e<o[0].events.length;e++){const a=o[0].events[e];if("bpm"===a.name&&0===a.position){t=!0;break}}t||o[0].events.unshift({name:"bpm",position:0,value:e.bpm})}let p=0;switch(a.course.toLowerCase()){case"easy":case"0":p=0;break;case"normal":case"1":p=1;break;case"hard":case"2":p=2;break;case"oni":case"3":p=3;break;case"edit":case"ura":case"4":p=4}if(l)o.push({length:[n,s],properties:r,data:l,events:c});else for(let e of c)e.position=o[o.length-1].data.length,o[o.length-1].events.push(e);return console.log(o[o.length-1]),{course:p,headers:a,measures:o}}function m(e,t,a,o,n,s,r){e.beginPath(),e.moveTo(t,a),e.lineTo(o,n),e.lineWidth=s,e.strokeStyle=r,e.stroke(),e.closePath()}function k(e,t,a,o,n){e.beginPath(),e.arc(t,a,o,0,2*Math.PI,!1),e.fillStyle=n,e.fill(),e.closePath()}function y(e,t,a,o,n,s){e.fillStyle=s,e.fillRect(t,a,o,n)}function v(e,t,a,o,n,s){let r=arguments.length>6&&void 0!==arguments[6]?arguments[6]:"middle",l=arguments.length>7&&void 0!==arguments[7]?arguments[7]:"center";e.font=n,e.textBaseline=r,e.textAlign=l,e.fillStyle=s,e.fillText(o,t,a)}function E(e,t,a,o,n){let s=arguments.length>5&&void 0!==arguments[5]?arguments[5]:"middle",r=arguments.length>6&&void 0!==arguments[6]?arguments[6]:"center";v(e,t,a,o,'5px "Pixel 3x5"',n,s,r)}const S=e=>112+66*e,x=e=>24+48*e;function O(e,t){return{x:x(t),y:S(e)+34}}function T(e,t,a,o){let n=!(arguments.length>4&&void 0!==arguments[4])||arguments[4];const{x:s,y:r}=O(t,a);k(e,s,r,9,"#000"),n?(k(e,s,r,8,"#fff"),k(e,s,r,7,o)):k(e,s,r,8,o)}function N(e,t,a,o){const{x:n,y:s}=O(t,a);k(e,n,s,12,"#000"),k(e,n,s,11,"#fff"),k(e,n,s,9,o)}function R(e,t,a,o,n,s,r){let l=arguments.length>7&&void 0!==arguments[7]?arguments[7]:"body",{x:c,y:i}=O(a,o),{x:d,y:f}=O(n,s);const p="gogo"===l,u="bodyBig"===l,h=p?34:9+(u?3:0);i-=h,f-=h;const g=p?18:18+(u?6:0);if(a===n){const t=d-c;p?y(e,c,i,t,g,r):(y(e,c,i,t,g,"#000"),y(e,c,i+1,t,g-2,"#fff"),y(e,c,i+2,t,g-4,r))}else{const o=t[a].totalBeat,l=x(o)-c+24;p?y(e,c,i,l,g,r):(y(e,c,i,l,g,"#000"),y(e,c,i+1,l,g-2,"#fff"),y(e,c,i+2,l,g-4,r));for(let o=a+1;o<n;o++){let a=S(o),n=x(t[o].totalBeat)+24;p?y(e,0,a,n,g,r):(a+=25-(u?3:0),y(e,0,a,n,g,"#000"),y(e,0,a+1,n,g-2,"#fff"),y(e,0,a+2,n,g-4,r))}const d=x(s);p?y(e,0,f,d,g,r):(y(e,0,f,d,g,"#000"),y(e,0,f+1,d,g-2,"#fff"),y(e,0,f+2,d,g-4,r))}}function B(e,t,a,o,n,s){T(e,a,o,"#fe4"),T(e,n,s,"#fe4"),R(e,t,a,o,n,s,"#fe4","body")}function w(e,t,a,o,n,s){N(e,a,o,"#fe4"),N(e,n,s,"#fe4"),R(e,t,a,o,n,s,"#fe4","bodyBig")}function A(e,t,a,o,n,s,r){T(e,n,s,"#fb4"),R(e,t,a,o,n,s,"#fb4","body"),T(e,a,o,"#fb4",!1);const{x:l,y:c}=O(a,o);E(e,l,c+.5,r.toString(),"#000")}function C(e,t,a,o,n,s,r){T(e,n,s,"#640aad"),R(e,t,a,o,n,s,"#640aad","body"),T(e,a,o,"#a4f",!1);const{x:l,y:c}=O(a,o);E(e,l,c+.5,r.toString(),"#fcc")}var I=function(e,t){const a=function(e){const t=[],a=[];let o=0,n=0,s=!1;for(let r=0;r<e.measures.length;r++){const l=e.measures[r],c=l.length[0]/l.length[1]*4;for(let e=0;e<l.events.length;e++){const a=l.events[e],n=c/(l.data.length||1)*a.position;"bpm"===a.name?t.push({type:"bpm",value:a.value,beat:o+n}):"gogoStart"===a.name?t.push({type:"gogoStart",beat:o+n}):"gogoEnd"===a.name&&t.push({type:"gogoEnd",beat:o+n})}for(let t=0;t<l.data.length;t++){const r=l.data.charAt(t);let i={type:"",beat:o+c/l.data.length*t};switch(r){case"1":i.type="don";break;case"2":i.type="kat";break;case"3":case"A":i.type="donBig";break;case"4":case"B":i.type="katBig";break;case"5":i.type="renda";break;case"6":i.type="rendaBig";break;case"7":i.type="balloon",i.count=e.headers.balloon[n++];break;case"8":i.type="end",s&&(s=!1);break;case"9":!1===s&&(i.type="balloon",i.count=e.headers.balloon[n++],s=!0);break;case"C":i.type="mine";break;case"D":i.type="fuse",i.count=e.headers.balloon[n++];break;case"F":i.type="adlib";break;case"G":i.type="kadon"}i.type&&a.push(i)}o+=c}return function(e,t){let a=120,o=0,n=0,s=0,r=0,l=[];for(;r<t.length;){let c=e[s],i=t[r];for(;c&&c.beat<=i;){if("bpm"===c.type){let e=c.beat-o;o+=e,n+=60/a*e,a=c.value}s++,c=e[s]}let d=i-o,f=60/a*d;l.push(n+f),o+=d,n+=f,r++}return l}(t,a.map(e=>e.beat)).forEach((e,t)=>{a[t].time=e}),{headers:e.headers,events:t,notes:a}}(e.courses[t]);return{statistics:function(e){const t=[0,0,0,0,0],a=[],o=[];let n=0,s=0,r=0,l=0,c=0,i=!1,d=!1,f=0,p=0,u="balloon",h=0,g=e.events[h],b=0,m=[[0,0,0,0,0],[0,0,0,0,0]],k=[0,0],y=[0,0],v=0;const E=["don","kat","donBig","katBig","kadon"];for(let S=0;S<e.notes.length;S++){const x=e.notes[S];if(g&&g.beat<=x.beat)do{"gogoStart"===g.type?b=1:"gogoEnd"===g.type&&(b=0),h+=1,g=e.events[h]}while(g&&g.beat<=x.beat);const O=E.indexOf(x.type);if(-1===O)if("renda"!==x.type&&"rendaBig"!==x.type)if("balloon"!==x.type&&"fuse"!==x.type)if("end"===x.type){if(i)a.push(x.time-i),i=!1;else if(d){const e=x.time-d,t=f/e;o.push([e,f,u]),d=!1,t<=60&&(k[p]+=f-1,y[p]+=1)}}else"adlib"===x.type?n++:"mine"===x.type&&s++;else d=x.time,f=x.count,p=b,u=x.type;else i=x.time;else{0===S&&(r=x.time),l=x.time,t[O]+=1,c+=1;const a=2===O||3===O||4===O,o=c<10?0:c<30?1:c<50?2:c<100?3:4;m[b][o]+=a?2:1;let n=e.headers.scoreInit+e.headers.scoreDiff*(c<10?0:c<30?1:c<50?2:c<100?4:8),s=10*Math.floor(n/10);b&&(s=10*Math.floor(1.2*s/10)),a&&(s*=2),v+=s}}return{totalCombo:c,notes:t,length:l-r,rendas:a,balloons:o,score:{score:v,notes:m,balloon:k,balloonPop:y},adlibs:n,mines:s}}(a),graph:function(e){const t=[];let a={don:0,kat:0,kadon:0},o=0;const n=e.notes[e.notes.length-1].time/100,s=["don","kat","donBig","katBig","kadon"];for(let r=0;r<e.notes.length;r++){const l=e.notes[r];if(-1!==s.indexOf(l.type)){for(;(t.length+1)*n<=l.time;){const e=a.don+a.kat+a.kadon;o<e&&(o=e),t.push(a),a={don:0,kat:0,kadon:0}}"don"===l.type||"donBig"===l.type?a.don+=1:"kat"===l.type||"katBig"===l.type?a.kat+=1:"kadon"===l.type&&(a.kadon+=1)}}for(;t.length<100;)t.push({don:0,kat:0,kadon:0});return{timeframe:n,max:o,data:t}}(a)}};a(104),a(105);const L=s()("#charset-utf-8").first(),D=s()("#charset-shift-jis").first(),F=s()("#charset-gb18030").first(),M=s()("#editor-live").first(),P=s()("#auto-scroll-to-bottom").first(),G=s()(".editor-process"),j=s()(".area-editor .input"),U=s()(".area-errors .errors");let H=null,V="",W="preview";function _(e){U.text(e)}function q(){s()(".controls-diff .button.is-active").removeClass("is-active"),s()(".controls-diff .btn-diff-".concat(V)).addClass("is-active"),s()(".controls-page .button.is-active").removeClass("is-active"),s()(".controls-page .btn-page-".concat(W)).addClass("is-active"),s()(".area-pages .page").addClass("is-hidden"),s()(".area-pages .page-".concat(W)).removeClass("is-hidden"),"preview"===W&&""!==V?K():s()("#tja-preview").remove(),"statistics"===W&&function(){if(""===V)return;try{!function(e){const{statistics:t,graph:a}=e;s()(".stat-total-combo").text(t.totalCombo);const o=H.courses[V],{scoreInit:n,scoreDiff:l}=o.headers,c=e=>10*Math.floor(e/10),i=[0,1,2,4,8].map(e=>c(n+l*e)),d=i.map(e=>c(1.2*e)),f=i.map((e,a)=>t.score.notes[0][a]*e).reduce((e,t)=>e+t,0)+d.map((e,a)=>t.score.notes[1][a]*e).reduce((e,t)=>e+t,0)+300*t.score.balloon[0]+360*t.score.balloon[1]+5e3*t.score.balloonPop[0]+6e3*t.score.balloonPop[1]+1e4*Math.floor(t.totalCombo/100);t.rendas.length?s()(".stat-max-score").text("".concat(f)):s()(".stat-max-score").text("".concat(f," Points"));s()(".stat-don-small").text(t.notes[0]),s()(".stat-don-big").text(t.notes[2]),s()(".stat-kat-small").text(t.notes[1]),s()(".stat-kat-big").text(t.notes[3]);const p=t.notes[0]+t.notes[2],u=t.notes[1]+t.notes[3],h=t.notes[4];s()(".stat-don").text(p),s()(".stat-kat").text(u),s()(".stat-kadon").text(t.notes[4]),s()(".stat-adlib").text(t.adlibs),s()(".stat-mine").text(t.mines);const g=p/t.totalCombo*100,b=u/t.totalCombo*100,m=h/t.totalCombo*100;s()(".stat-don-ratio").text(g.toFixed(2)+"%"),s()(".stat-kat-ratio").text(b.toFixed(2)+"%"),s()(".stat-kadon-ratio").text(m.toFixed(2)+"%"),s()(".stat-density").text((t.totalCombo/t.length).toFixed(3)),s()(".stat-length").text(t.length.toFixed(2));s()(".stat-formatted-length").text((k=t.length,"".concat(Math.floor(k/60),"m").concat((k%60).toFixed(2).padStart(5,"0"),"s"))),s()(".stat-renda").text(t.rendas.map(e=>e.toFixed(3)+"s").join(" + ")),s()(".stat-renda-total").text(t.rendas.reduce((e,t)=>e+t,0).toFixed(3)+"s"),s()(".stat-balloon").html(t.balloons.map(e=>"".concat(e[1],"hit(s) / ").concat(e[0].toFixed(3),"s = ").concat((e[1]/e[0]).toFixed(3)," hit/s").concat("fuse"===e[2]?" [💣]":"")).join("<br>"));var k;const y=r.b().rangeRound([0,600]),v=r.c().rangeRound([200,0]),E=5*Math.ceil(a.max/5),S=[...Array(E/5+1).keys()].map(e=>5*e);s()(".stat-graph").empty();const x=r.d(".stat-graph").attr("width",650).attr("height",240).append("g").attr("transform","translate(30, 20)"),O=r.e().keys(["kadon","don","kat"])(a.data);y.domain(O[0].map((e,t)=>t)),v.domain([0,5*Math.ceil(a.max/5)]);const T=()=>r.a(v).ticks(5).tickValues(S);x.append("g").attr("class","grid").call(T().tickSize(-600).tickFormat(""));x.selectAll(".layer").data(O).enter().append("g").attr("class","layer").style("fill",(e,t)=>["#f0f","#f00","#00f"][t]).selectAll("rect").data(e=>e).enter().append("rect").attr("x",(e,t)=>y(t)).attr("y",e=>v(e[1])).attr("height",e=>v(e[0])-v(e[1])).attr("width",y.bandwidth),x.append("g").attr("class","axis-y").call(T())}(I(H,V))}catch(e){console.error(e),_(e.message)}}()}function J(){try{H=function(e){const t=e.split(/(\r\n|\r|\n)/).map(e=>e.trim()),a={title:"",subtitle:"",bpm:120,wave:"",offset:0,demoStart:0,genre:"",maker:null},o={};let n,s=[];for(n=0;n<t.length;n++){const e=t[n];if(""===e)continue;const r=g(e);if("header"===r.type&&"global"===r.scope)switch(r.name){case"TITLE":a.title=r.value;break;case"SUBTITLE":a.subtitle=r.value.replace(/^(\+\+|--)/,"");break;case"BPM":a.bpm=parseFloat(r.value);break;case"WAVE":a.wave=r.value;break;case"OFFSET":a.offset=parseFloat(r.value);break;case"DEMOSTART":a.demoStart=parseFloat(r.value);break;case"GENRE":a.genre=r.value;break;case"MAKER":a.maker=r.value}else if("header"===r.type&&"course"===r.scope){if("COURSE"===r.name&&s.length){const e=b(a,s);o[e.course]=e,s=[]}s.push(r)}else("command"===r.type||"data"===r.type)&&s.push(r)}if(s.length){const e=b(a,s);o[e.course]=e}return{headers:a,courses:o}}(j.first().value),s()(".controls-diff .button").addClass("is-hidden");for(let e in H.courses)s()(".controls-diff .btn-diff-".concat(e)).removeClass("is-hidden");_("No error")}catch(e){console.error(e),_(e.message)}}function K(){""!==V&&(s()("#tja-preview").remove(),document.fonts.load('5px "Pixel 3x5"').then(()=>{try{const e=function(e,t){const a=e.courses[t],o=a.headers.ttRowBeat,n=[];let s=[],r=0;for(let e=0;e<a.measures.length;e++){const t=a.measures[e],l=t.length[0]/t.length[1]*4;(o<r+l||t.properties.ttBreak)&&(n.push({beats:r,measures:s}),s=[],r=0),s.push(t),r+=l}s.length&&n.push({beats:r,measures:s});const l=24+48*o+24,c=112+66*n.length+8,i=document.createElement("canvas");i.width=l,i.height=c,document.body.appendChild(i);const d=i.getContext("2d");try{y(d,0,0,l,c,"#cccccc");for(let e=0;e<n.length;e++){const t=n[e],a=t.beats;t.measures;t.totalBeat=a;const o=24+48*a+24,s=S(e);y(d,0,s+18,o,32,"#000"),y(d,0,s+18+2,o,28,"#fff"),y(d,0,s+18+4,o,24,"#999")}v(d,8,8,e.headers.title,"bold 28px sans-serif","#000","top","left"),v(d,8,40,e.headers.subtitle,"bold 20px sans-serif","#000","top","left"),null===a.headers.maker&&null===e.headers.maker||v(d,8,64,"Charter: ".concat(null!==a.headers.maker?a.headers.maker:e.headers.maker),"bold 20px sans-serif","#000","top","left");const t=[5,7,8,10,10];v(d,8,88,["Easy","Normal","Hard","Oni","Edit"][a.course]+" "+"★".repeat(a.headers.level)+"☆".repeat(Math.max(t[a.course]-a.headers.level,0))+" Lv.".concat(a.headers.level),"bold 20px sans-serif","#000","top","left");let o=!1,s=1;for(let e=0;e<n.length;e++){const t=n[e].measures;let a=0;for(let s=0;s<t.length;s++){const r=t[s],l=r.length[0]/r.length[1]*4;r.rowBeat=a;for(let t=0;t<r.events.length;t++){const s=r.events[t],c=a+l/(r.data.length||1)*s.position;"gogoStart"!==s.name||o?"gogoEnd"===s.name&&o&&(R(d,n,o[0],o[1],e,c,"#fbb","gogo"),o=!1):o=[e,c]}a+=l}}for(let e=0;e<n.length;e++){const t=n[e].measures;let a=0;const o=S(e);for(let e=0;e<t.length;e++){const n=x(a),r=t[e],l=r.length[0]/r.length[1]*4,c=o+18;for(let e=1;e<2*r.length[0];e++){const t=e/r.length[1]*2,o=x(a+t);m(d,o,c,o,c+32,2,"#fff"+(e%2?"4":"8"))}for(let e=0;e<r.events.length;e++){const t=r.events[e],n=l/(r.data.length||1)*t.position,s=x(a+n);"scroll"===t.name?(m(d,s,o,s,o+50,2,"#444"),E(d,s+2,o+18-13,"HS "+t.value.toString(),"#f00","bottom","left")):"bpm"===t.name&&(m(d,s,o,s,o+50,2,"#444"),E(d,s+2,o+18-7,"BPM "+t.value.toString(),"#00f","bottom","left"))}if(m(d,n,o,n,o+50,2,"#fff"),E(d,n+2,o+18-1,s.toString(),"#000","bottom","left"),s+=1,a+=l,e+1===t.length){const e=x(a);m(d,e,o,e,o+50,2,"#fff")}}}let r=0,f=!1;for(let e=0;e<n.length;e++){const t=n[e].measures;for(let e=0;e<t.length;e++){const a=t[e];for(let e=a.data.length;e>=0;e--){const t=a.data.charAt(e);"7"===t||"D"===t?r+=1:"9"!==t||f?"8"===t&&f&&(f=!1):(f=1,r+=1)}}}if(a.headers.balloon.length<r)throw new Error("BALLOON count mismatch");let p=!1,u=!1;for(let e=n.length-1;e>=0;e--){const t=n[e].measures;for(let o=t.length-1;o>=0;o--){const s=t[o],l=s.length[0]/s.length[1]*4;for(let t=s.data.length;t>=0;t--){const o=s.data.charAt(t),c=s.rowBeat+l/s.data.length*t;if("0"!==o&&"9"!==o&&u){u[0];const e=u[u.length-1],t=a.headers.balloon[r-1];A(d,n,e[0],e[1],p[0],p[1],t),r-=1,p=!1,u=!1}switch(o){case"1":T(d,e,c,"#f33");break;case"2":T(d,e,c,"#5cf");break;case"3":case"A":N(d,e,c,"#f33");break;case"4":case"B":N(d,e,c,"#5cf");break;case"5":B(d,n,e,c,p[0],p[1]),p=!1;break;case"6":w(d,n,e,c,p[0],p[1]),p=!1;break;case"7":const t=a.headers.balloon[r-1];A(d,n,e,c,p[0],p[1],t),r-=1,p=!1;break;case"8":p=[e,c];break;case"9":u||(u=[]),u.push([e,c]);break;case"C":T(d,e,c,"#000");break;case"D":const o=a.headers.balloon[r-1];C(d,n,e,c,p[0],p[1],o),r-=1,p=!1;break;case"F":T(d,e,c,"#ddd");break;case"G":N(d,e,c,"#f3f")}}}}return document.body.removeChild(i),i}catch(e){throw document.body.removeChild(i),e}}(H,V);e.id="tja-preview",s()(".page-preview").append(e),_("No error")}catch(e){console.error(e),_(e.message)}}))}G.on("click",()=>{J(),K()}),j.on("input",()=>{M.checked&&(J(),q(),P.checked&&setTimeout(()=>{let e=document.getElementById("area-pages");e.scrollTo(0,e.scrollHeight)},100))}),j.on("dragover",e=>{e.stopPropagation(),e.preventDefault(),e.dataTransfer.dropEffect="cppy"}),j.on("drop",e=>{e.stopPropagation(),e.preventDefault();const t=e.dataTransfer.files[0],a=new FileReader;a.onload=e=>{const t=e.target.result,a=new Uint8Array(t),n=o.Buffer.from(a);let s;s=L.checked?"UTF-8":D.checked?"Shift-JIS":F.checked?"GB18030":p.a.detect(n);const r=h.a.decode(n,s);j.first().value=r,V="",J(),q()},a.readAsArrayBuffer(t)}),s()(".controls-diff .button").on("click",e=>{const t=s()(e.target).data("value");V=t,q()}),s()(".controls-page .button").on("click",e=>{const t=s()(e.target).data("value");W=t,q()}),s()(".btn-download").on("click",e=>{"preview"===W?(async()=>{if(null===!H||""===V)return void alert("Please select a chart and difficulty");const e=document.querySelector("#tja-preview");if(!e)return;const t=e.toDataURL("image/png");c()(t,"".concat(H.headers.title,".preview.png"),"image/png")})():(async()=>{if(null===!H||""===V)return void alert("Please select a chart and difficulty");const e=document.querySelector(".area-pages");if(!e)return;const t=e.cloneNode(!0);t.style.position="fixed",t.style.right="100%",t.style.width="100%",t.style.height="auto",document.body.append(t);const a=await d()(t);t.remove();const o=a.toDataURL("image/png");c()(o,"".concat(H.headers.title,".statistics.png"),"image/png")})()}),s()(".btn-unique").on("click",e=>{(async()=>{if(null===!H)return void alert("Please select a chart");const e={id:(H.headers.title+H.headers.subtitle).replace(/[^a-zA-Z0-9]/g,"").split("").map(e=>Math.random()<.5?e.toLowerCase():e.toUpperCase()).join(""),url:""};c()(JSON.stringify(e),"uniqueId.json","application/json")})()}),j.first().value&&J(),q()}});